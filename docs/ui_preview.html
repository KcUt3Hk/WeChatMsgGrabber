<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>微信聊天记录获取助手（WeChatMsgGraber）</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    .header { margin-bottom: 12px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .tag { display:inline-block; background:#f4f4f4; border:1px solid #ddd; border-radius:6px; padding:2px 6px; margin-right:6px; margin-bottom:6px; font-size:12px; line-height:20px; }
    .tag.clickable { background:#e6f4ff; border-color:#91caff; color:#0958d9; cursor:pointer; }
    .tag.clickable:hover { background:#dbeeff; }
    code { background:#f9f9f9; border:1px solid #eee; border-radius:4px; padding:2px 4px; }
    .banner { background:#fffbe6; border:1px solid #ffe58f; border-radius:8px; padding:10px; margin-top:8px; }
    .btn { display:inline-block; padding:6px 12px; border-radius:6px; border:1px solid #d9d9d9; background:#f0f0f0; cursor:pointer; font-size:12px; margin-left:8px; margin-bottom:8px; }
    .btn-primary { background:#1677ff; border-color:#1677ff; color:#fff; }
    /* 分组标题下边距，优化上下按钮行间距 */
    h3 { margin: 0 0 8px 0; }
    /* 表单样式增强 */
    .form-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .form-row { margin-bottom: 10px; }
    .form-control { width: 100%; height: 38px; padding: 6px 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 13px; box-sizing: border-box; }
    select.form-control { height: 38px; }
    .help { color:#808080; font-size:12px; margin-top:4px; }
    .section-note { color:#666; font-size:12px; }
    /* 校验错误样式 */
    .form-control.error { border-color: #ff4d4f; background: #fff1f0; }
    .error-msg { color: #cf1322; font-size: 12px; margin-top: 4px; display: none; }
    .exports-list { margin-top:8px; font-size:13px; }
    .exports-list li { margin-bottom:4px; }
    /* 指标高亮样式 */
    .metric-tag { display:inline-block; padding:2px 6px; border-radius:6px; border:1px solid #d9d9d9; font-size:12px; }
    .metric-good { color:#389e0d; background:#f6ffed; border-color:#b7eb8f; }
    .metric-warn { color:#faad14; background:#fffbe6; border-color:#ffe58f; }
    .metric-bad { color:#cf1322; background:#fff2f0; border-color:#ffa39e; }
    /* 模块统一样式 */
    .module { border: 1px solid #e5eaf0; border-radius: 10px; padding: 12px 14px; margin: 20px 0; background: #fafcff; }
    .module-title { margin: 0 0 8px; font-size: 18px; color: #2b3a67; }
    .module-body { margin-top: 6px; }
    .module .card { background: #fff; border-color: #eef2f7; margin-bottom: 12px; }
    /* ShareCard 统一样式（标题-正文≥8px、正文-来源≥6px） */
    .share-card { border: 1px solid #e3e6eb; border-radius: 8px; padding: 10px 12px; background: #fff; max-width: 520px; margin: 10px 0; }
    .share-card .share-title { font-size: 15px; font-weight: 600; color: #1f2328; margin-bottom: 8px; }
    .share-card .share-body { font-size: 13px; color: #3b3b3b; margin-bottom: 6px; }
    .share-card .share-source { font-size: 12px; color: #808080; }
    /* 引用气泡统一样式与标签（左上角灰色小字标注“我/对方”） */
    .bubble { position: relative; display: inline-block; border-radius: 8px; padding: 22px 14px 10px; max-width: 520px; margin: 10px; line-height: 1.5; }
    .bubble.me { background: #e6f4ff; border: 1px solid #91caff; }
    .bubble.other { background: #f5f5f5; border: 1px solid #d9d9d9; }
    .bubble-label { position: absolute; top: 6px; left: 10px; font-size: 12px; color: #888; }
    .bubble-content { font-size: 14px; color: #1f2328; }
  </style>
  <script>
    /**
     * 复制启动开发者服务器的命令到剪贴板
     * - 服务：web/config_server.py
     * - 端口：8003（可根据需要调整）
     * - 使用当前解释器路径：getPythonBin()
     * 说明：该服务提供配置读写与指标接口，供“网页预览”模块联动使用。
     * @returns {void}
     */
    function copyRunDevServerCommand() {
      const py = getPythonBin();
      const cmd = `${py} ${PROJECT_ROOT}/web/config_server.py --port 8003`;
      copyText(cmd);
    }
    // Python 路径示例（仅演示；真实检测请在桌面 UI 中点击“自动检测”）
    // 默认解释器路径（可在下方输入框覆盖）：使用通用命令 'python3'，避免显示个人目录。
    // 如在其他设备使用，请在输入框填写对应绝对路径或通过桌面 UI 的“自动检测”获取。
    const PYBIN = 'python3';
    // 项目根目录示例（示例命令使用相对路径，避免泄露个人路径信息）
    const PROJECT_ROOT = '.';
    /**
     * 将文本复制到系统剪贴板
     * @param {string} txt 要复制的文本
     * @returns {void}
     */
    function copyText(txt) {
      if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(txt).then(function() {
          alert('已复制到剪贴板');
        }).catch(function(err) {
          alert('复制失败：' + err);
        });
      } else {
        // 兼容处理：创建临时 textarea 进行复制
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); alert('已复制到剪贴板'); } catch (e) { alert('复制失败：' + e); }
        document.body.removeChild(ta);
      }
    }

    /**
     * 获取 Python 解释器路径
     * - 优先：页面输入框（id: f_python_bin）
     * - 其次：localStorage('python_bin')
     * - 回退：常量 PYBIN（默认值：python3）
     * 目的：避免硬编码失败，提供跨设备可用的默认值，并允许用户覆盖。
     * @returns {string}
     */
    function getPythonBin() {
      var inp = document.getElementById('f_python_bin');
      var fromInput = inp && inp.value && inp.value.trim();
      if (fromInput) return fromInput;
      var fromLocal = (typeof localStorage !== 'undefined') ? (localStorage.getItem('python_bin') || '').trim() : '';
      if (fromLocal) return fromLocal;
      return PYBIN; // 回退到示例默认值
    }

    /**
     * 持久化当前输入框中的 Python 解释器路径到 localStorage。
     * @returns {void}
     */
    function persistPythonBin() {
      var inp = document.getElementById('f_python_bin');
      if (!inp) return;
      var v = (inp.value || '').trim();
      if (typeof localStorage !== 'undefined') {
        if (v) localStorage.setItem('python_bin', v);
        else localStorage.removeItem('python_bin');
      }
    }

    // 取消“推荐解释器”硬编码，避免绑定个人环境；保留 getPythonBin 动态获取逻辑。

    /**
     * 将绝对路径进行脱敏以用于页面展示（不影响复制的真实路径）
     * 示例：将用户主目录绝对路径统一展示为 $HOME/xxx
     * @param {string} path 原始绝对路径
     * @returns {string} 脱敏后的展示路径
     */
    function sanitizePathForDisplay(path) {
      var s = String(path || '');
      s = s.replace(/^\/Users\/[^/]+/, '$HOME');
      s = s.replace(/^\/home\/[^/]+/, '$HOME');
      return s;
    }

    /**
     * 显示提示信息
     * @param {string} msg 提示文案
     * @returns {void}
     */
    function showInfo(msg) {
      alert(msg);
    }

    /**
     * 复制自动扫描命令到剪贴板
     * @returns {void}
     */
    function copyScanCommand() {
      const py = getPythonBin();
      const cmd = `${py} ${PROJECT_ROOT}/cli/auto_wechat_scan.py --direction up --max-scrolls 60 --max-scrolls-per-minute 40 --formats json,csv --output ./output --filename-prefix auto_wechat_scan --verbose --skip-empty`;
      copyText(cmd);
    }

    /**
     * 复制扩展时间轴扫描命令到剪贴板（full_timeline_scan.py）
     * 用途：对单个或多个会话进行更完整的历史扫描（包含可选的高级滚动控制）。
     * @returns {void}
     */
    function copyFullTimelineScanCommand() {
      const py = getPythonBin();
      const cmd = `${py} ${PROJECT_ROOT}/cli/full_timeline_scan.py --direction up --max-scrolls 120 --max-scrolls-per-minute 40 --formats json,csv,md --output ./output --filename-prefix full_timeline --verbose --skip-empty`;
      copyText(cmd);
    }

    /**
     * 复制高级扫描命令到剪贴板（run_advanced_scan.py）
     * 用途：启用 AdvancedScrollController（惰性与惯性滚动、窗口高度自适应等），适合长会话稳定采集。
     * @returns {void}
     */
    function copyRunAdvancedScanCommand() {
      const py = getPythonBin();
      const cmd = `${py} ${PROJECT_ROOT}/cli/run_advanced_scan.py --direction up --max-scrolls 180 --max-scrolls-per-minute 36 --formats json,csv,md --output ./output --filename-prefix adv_scan --verbose --skip-empty`;
      copyText(cmd);
    }

    /**
     * 复制基础提取命令到剪贴板（run_extraction.py）
     * 用途：在已捕获图像基础上执行 OCR 与解析，适合离线清洗与合并导出流程。
     * @returns {void}
     */
    function copyRunExtractionCommand() {
      const py = getPythonBin();
      const cmd = `${py} ${PROJECT_ROOT}/cli/run_extraction.py --formats json,csv,md --output ./output --filename-prefix extracted --verbose`;
      copyText(cmd);
    }

    /**
     * 复制启动桌面 UI 的命令（常规模式）。
     * @returns {void}
     */
    function copyRunUiCommand() {
      const py = getPythonBin();
      const cmd = `${py} ${PROJECT_ROOT}/ui/simple_gui.py`;
      copyText(cmd);
    }

    /**
     * 复制启动桌面 UI 的命令（安全模式）。
     * @returns {void}
     */
    function copyRunUiSafeCommand() {
      const py = getPythonBin();
      const cmd = `export WX_SAFE_MODE=1 && ${py} ${PROJECT_ROOT}/ui/simple_gui.py`;
      copyText(cmd);
    }

    /**
     * 复制安装 Pillow 的命令（使用当前解释器）。
     * @returns {void}
     */
    function copyInstallPillowCommand() {
      const py = getPythonBin();
      const cmd = `${py} -m pip install pillow`;
      copyText(cmd);
    }

    /**
     * 复制聊天区域预览命令到剪贴板
     * @returns {void}
     */
    function copyPreviewCommand() {
      const py = getPythonBin();
      const cmd = `${py} ${PROJECT_ROOT}/scripts/capture_rect_preview.py --rect 120,80,920,900 --out ./outputs/debug_chat_area_preview.png`;
      copyText(cmd);
    }

    /**
     * 复制打开输出目录命令到剪贴板（macOS）
     * @returns {void}
     */
    function copyOpenOutput() {
      copyText(`open ./output`);
    }

    /**
     * 复制配置模板（JSON）到剪贴板
     * @returns {void}
     */
    function copyConfigTemplate() {
      const tpl = {
        app: { scroll_speed: 2, scroll_delay: 1.0, max_retry_attempts: 3 },
        ocr: { language: 'ch', confidence_threshold: 0.7 },
        output: { format: 'json', directory: './output', enable_deduplication: true, formats: ['json','csv'] }
      };
      copyText(JSON.stringify(tpl, null, 2));
      alert('已复制配置模板到剪贴板');
    }

    /**
     * 复制当前示例 Python 解释器路径到剪贴板
     * @returns {void}
     */
    function copyPythonPath() {
      copyText(getPythonBin());
    }
  </script>
  <!-- 本页用于说明新增的 Tkinter 简易前端 UI 的功能点与运行方式；可选：通过本地配置服务联动参数编辑与保存。 -->
</head>
<body>
  <!-- 页眉（一般标题 + 一句话介绍），替代原“项目名称/项目介绍”两个大模块 -->
  <div class="header">
<h1>微信聊天记录获取助手（WeChatMsgGraber）</h1>
    <p>本页用于说明与预览，支持参数设置、性能指标与最新导出。</p>
  </div>

  <!-- 目录（移除项目名称/介绍，仅保留 1/2/3 三个模块） -->
  <div class="card" id="toc">
    <h2>目录（快速跳转）</h2>
    <ul>
      <li><a href="#module-guide-cli">1. 使用指南：一键自动化脚本</a></li>
      <li><a href="#module-guide-desktop">2. 使用指南：桌面应用</a></li>
      <li><a href="#module-guide-web">3. 使用指南：网页预览</a></li>
    </ul>
  </div>

  <!-- 快速预览与开发者服务器卡片，保留在页眉下方（非模块大标题） -->
  <div class="card">
    <h2>快速预览静态页面</h2>
    <p>若仅需预览页面样式与静态功能（不调用 API），可使用内置 HTTP 服务器在 <code>docs</code> 目录下启动：</p>
    <p>
      <code>python3 -m http.server 8002 --directory docs</code>
      <button class="btn" onclick="copyText('python3 -m http.server 8002 --directory docs')">复制预览命令</button>
    </p>
    <p>启动成功后，打开：<code>http://localhost:8002/ui_preview.html</code>。注意：不要访问 <code>/docs/ui_preview.html</code>，否则可能 404。</p>
  </div>
  <div class="card">
    <h2>开发者服务器与调试</h2>
    <p>如需联动后端配置服务与指标接口，请启动开发者服务器：</p>
    <p>
      <code>python3 web/config_server.py --port 8003</code>
      <button class="btn btn-primary" onclick="copyRunDevServerCommand()">复制启动命令（当前解释器）</button>
    </p>
    <p>启动后访问：<code>http://localhost:8003/ui_preview.html</code>；如遇 404，请确认访问路径不带 <code>/docs/</code> 前缀。</p>
  </div>

  <div class="module" id="module-guide-cli">
    <h2 class="module-title">1. 使用指南：一键自动化脚本</h2>
    <div class="module-body">
      <div class="card">
        <h2>一键自动化脚本：命令与用法</h2>
        <p>
          若不使用桌面 UI，也可直接运行命令行脚本完成批量或高级采集：
        </p>
        <ul>
          <li>
            <strong>扩展时间轴扫描：</strong>
            <code>cli/full_timeline_scan.py</code> 适合完整历史扫描，支持更长滚动与多格式导出。
            <button class="btn" onclick="copyFullTimelineScanCommand()">复制 full_timeline_scan 命令</button>
          </li>
          <li>
            <strong>高级滚动控制：</strong>
            <code>cli/run_advanced_scan.py</code> 启用 AdvancedScrollController（惰性与惯性滚动、窗口高度自适应等），提升长会话稳定性。
            <button class="btn" onclick="copyRunAdvancedScanCommand()">复制 advanced_scan 命令</button>
          </li>
          <li>
            <strong>基础提取（离线）：</strong>
            <code>cli/run_extraction.py</code> 在已捕获图像基础上执行 OCR 与解析，适合离线清洗与合并导出流程。
            <button class="btn" onclick="copyRunExtractionCommand()">复制 run_extraction 命令</button>
          </li>
        </ul>
        <div class="help">
          提示：
          <ul>
            <li>建议使用绝对路径的 Python 解释器（可在下方输入框设置），并在项目根目录执行以上命令。</li>
            <li>AdvancedScrollController 将控制滚动速度与节奏，减少模糊与遗漏；如遇异常退出可结合“桌面应用 → 安全模式与解释器选择”重试。</li>
            <li>如需更进一步的离线清洗与合并导出，可配合 <code>scripts/sanitize_export.py</code> 或自定义处理脚本。</li>
          </ul>
        </div>
        </div>
        <div class="card">
          <h2>常见问题（FAQ）</h2>
          <ul class="faq-list">
            <li><strong>auto_wechat_scan.py 不支持 txt 格式</strong>：取消勾选 txt；推荐 json/csv 或 md。</li>
            <li><strong>Segmentation fault/退出码 -9/134/139</strong>：降低滚动速率或改用 <code>run_advanced_scan.py</code>；若在桌面应用中，请使用安全模式。</li>
            <li><strong>无法前台控制“微信”窗口</strong>：使用 <code>scripts/capture_rect_preview.py</code> 验证 <code>x,y,w,h</code>，并在命令中直接填写坐标。</li>
            <li><strong>解释器路径问题</strong>：建议使用绝对路径（如 <code>$HOME/…/python_envs/bin/python3.12</code> 或 <code>/usr/bin/python3</code>）；也可在桌面 UI 里“自动检测”。</li>
          </ul>
        </div>
        <div class="back-to-toc"><a href="#toc">返回目录</a></div>
      </div>
    </div>
  </div>

  <div class="module" id="module-guide-desktop">
    <h2 class="module-title">2. 使用指南：桌面应用</h2>
    <div class="module-body">
  <div class="card">
    <h2>桌面应用：运行</h2>
    <p>在项目根目录运行桌面 UI（根据你环境的解释器路径运行）：</p>
    <p>
      <code>python3 ui/simple_gui.py</code>
      <button class="btn" onclick="copyText('python3 ui/simple_gui.py')">复制运行命令（python3）</button>
      <button class="btn btn-primary" onclick="copyRunUiCommand()">复制运行命令（当前解释器）</button>
    </p>
    <p>如首次运行提示缺少依赖，请安装 Pillow（使用当前解释器）：</p>
    <p>
      <code>python3 -m pip install pillow</code>
      <button class="btn" onclick="copyText('python3 -m pip install pillow')">复制安装命令（python3）</button>
      <button class="btn" onclick="copyInstallPillowCommand()">复制安装命令（当前解释器）</button>
    </p>
  </div>
  <div class="card">
    <h2>桌面应用：安全模式与解释器选择</h2>
    <p>
      为提高稳定性，桌面 UI 已在检测到异常退出（退出码 <code>-9/134/139</code> 或输出包含 <code>Killed/Abort trap/Segmentation fault</code>）时自动以“安全模式”重试。
      你也可以主动启用安全模式：
    </p>
    <p>
      <code>export WX_SAFE_MODE=1 && python3 ui/simple_gui.py</code>
      <button class="btn" onclick="copyText('export WX_SAFE_MODE=1 && python3 ui/simple_gui.py')">复制安全模式命令（python3）</button>
      <button class="btn btn-primary" onclick="copyRunUiSafeCommand()">复制安全模式命令（当前解释器）</button>
    </p>
    <div class="help">
      安全模式：命令追加 <code>-S -E</code> 并设置 <code>PYTHONNOUSERSITE</code>、<code>PYTHONDONTWRITEBYTECODE</code>、<code>WX_SAFE_MODE</code>；
      OCRProcessor 检测到 <code>WX_SAFE_MODE</code> 后启用 paddlex YAML 缓存与离线补丁，关闭 GPU。
      解释器路径可在下方设置；留空时复制命令将回退默认值（不显示个人目录）。
    </div>
  </div>

  <div class="card">
    <h2>桌面应用：操作步骤（新手指南）</h2>
    <ol>
      <li>
        <strong>设置解释器路径</strong>：在输入框里填写你的解释器路径，或在桌面 UI 中点击“自动检测”。
      </li>
      <li>
        <strong>安装依赖</strong>（首次运行）：
        <button class="btn" onclick="copyInstallPillowCommand()">复制安装 Pillow（当前解释器）</button>
      </li>
      <li>
        <strong>启动桌面 UI</strong>：
        <button class="btn btn-primary" onclick="copyRunUiCommand()">复制启动命令（当前解释器）</button>
      </li>
      <li>
        <strong>在 UI 中设置参数</strong>：选择窗口标题；框选聊天区域（<code>x,y,w,h</code>）。
        建议：<code>scroll-delay</code> 0.8～1.2 秒，<code>max-scrolls</code> 60～120，<code>spm</code> ≤40。
      </li>
      <li>
        <strong>设置 OCR 与输出</strong>：
        OCR 语言填写 <code>ch</code>；输出目录填写可写路径（如 <code>./output</code>）。
      </li>
      <li>
        <strong>开始扫描</strong>：点击“开始扫描”。若出现异常退出（-9/134/139 或 Killed/Abort trap/Segmentation fault），UI 将自动以安全模式重试。
        如需主动启用安全模式：
        <button class="btn" onclick="copyRunUiSafeCommand()">复制安全模式命令</button>
      </li>
      <li>
        <strong>查看导出</strong>：完成后打开输出目录（macOS）：
        <button class="btn" onclick="copyOpenOutput()">复制打开输出命令</button>
      </li>
    </ol>
    <div class="banner">提示：如你使用终端变量 <code>WX_PYTHON_BIN</code>，桌面 UI 的“自动检测 Python”会优先使用该解释器。</div>
  </div>

  <div class="card">
    <h2>如何确定 Python 路径</h2>
    <ul>
      <li>方法一：在桌面 UI 中点击“自动检测”，自动回填当前解释器路径。</li>
      <li>方法二：在终端执行 <code>python3 -c "import sys; print(sys.executable)"</code>，输出即为解释器路径。</li>
      <li>方法三：在终端执行 <code>which python3</code>（类 Unix 环境），或其他等效方式定位解释器。</li>
    </ul>
  <div class="card">
    <h2>常见问题（FAQ）</h2>
    <ul class="faq-list">
      <li><strong>UI 启动后立刻退出或提示缺少 Pillow</strong>：先安装 Pillow（上方“运行”部分提供按钮，或在终端执行）。</li>
      <li><strong>退出码 -9/134/139 或出现 Segmentation fault</strong>：使用安全模式重试（“安全模式与解释器选择”卡片）；安全模式会禁用用户 site 包、启用 paddlex 离线补丁并关闭 GPU。</li>
      <li><strong>无法前台控制“微信”窗口</strong>：直接填写聊天区域坐标（<code>x,y,w,h</code>），并点击“预览聊天区域”复制命令进行验证。</li>
      <li><strong>权限相关</strong>：请在“系统设置 → 隐私与安全性”中授予屏幕录制与辅助功能权限；框选窗口中可按 <code>Esc</code> 取消。</li>
    </ul>
  </div>
  <div class="back-to-toc"><a href="#toc">返回目录</a></div>
    </div>
  </div>

  <div class="module" id="module-guide-web">
    <h2 class="module-title">3. 使用指南：网页预览</h2>
    <div class="module-body">
  <div class="card">
    <h2>网页预览：核心功能</h2>
    <div class="grid">
      <div>
        <h3>参数设置</h3>
        <span class="tag">Python 解释器路径（可修改/自动检测）</span>
        <span class="tag">窗口标题</span>
        <span class="tag">聊天区域 x,y,w,h</span>
        <span class="tag">方向 up/down</span>
        <span class="tag">scroll-delay</span>
        <span class="tag">max-scrolls</span>
        <span class="tag">spm</span>
        <span class="tag">OCR 语言</span>
        <span class="tag">导出格式 json/csv/md</span>
        <span class="tag">输出目录</span>
        <span class="tag">文件前缀</span>
        <span class="tag">skip-empty</span>
        <span class="tag">verbose</span>
      </div>
      <div>
        <h3>操作</h3>
        <span class="tag clickable" title="复制当前 Python 路径到剪贴板" onclick="copyPythonPath()">复制当前 Python 路径</span>
        <span class="tag clickable" title="复制预览截图命令" onclick="copyPreviewCommand()">预览聊天区域</span>
        <span class="tag clickable" title="在桌面 UI 中执行框选" onclick="showInfo('请在桌面 UI 中操作（本页为预览，不提供真实框选）。')">框选聊天区域</span>
        <span class="tag clickable" title="复制扫描运行命令" onclick="copyScanCommand()">开始扫描</span>
        <span class="tag clickable" title="在桌面 UI 中停止扫描" onclick="showInfo('请在桌面 UI 中操作（本页不提供进程控制）。')">停止扫描</span>
        <span class="tag clickable" title="复制当前示例命令" onclick="copyScanCommand()">复制命令</span>
        <span class="tag clickable" title="复制配置模板到剪贴板" onclick="copyConfigTemplate()">保存配置</span>
        <span class="tag clickable" title="在桌面 UI 中加载配置" onclick="showInfo('请在桌面 UI 中加载配置（从项目根目录 ui_config.json 回填）。')">加载配置</span>
        <span class="tag clickable" title="复制打开输出目录命令" onclick="copyOpenOutput()">打开输出目录</span>
        <span class="tag clickable" title="桌面 UI 中退出程序" onclick="showInfo('请在桌面 UI 中退出程序。')">退出</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>网页预览：参数设置（交互）</h2>
    <p>以下表单可与后端服务联动，支持“加载配置”与“保存到项目”，会写入项目根目录的 <code>ui_config.json</code> 与 <code>config.json</code>。</p>
    <div class="form-grid">
      <div class="form-row">
        <label>Python 解释器路径</label><br />
        <!-- 输入框: Python 解释器路径。使用通用示例避免暴露个人目录 -->
        <input id="f_python_bin" class="form-control" placeholder="例如 $HOME/Projects/Setting/python_envs/bin/python3.12 或 python3" />
        <div class="help">说明：建议使用绝对路径；也可在桌面 UI 点击“自动检测”获取当前解释器路径。该输入会自动保存到浏览器（localStorage），刷新或重开页面自动恢复。</div>
      </div>
      <div class="form-row">
        <label>窗口标题</label><br />
        <input id="f_window_title" class="form-control" placeholder="如 WeChat/微信" />
        <div class="help">说明：用于对齐目标窗口；留空则由桌面 UI 识别或使用系统前台窗口。</div>
      </div>
      <div class="form-row">
        <label>聊天区域 (x,y,w,h)</label><br />
        <input id="f_chat_area" class="form-control" placeholder="例如 260,65,873,1211" />
        <div class="help">说明：坐标为 x,y,w,h；区域需覆盖消息列表（建议 w/h ≥ 200）；可通过“框选聊天区域”精确选择。</div>
      </div>
      <div class="form-row">
        <label>滚动方向</label><br />
        <select id="f_direction" class="form-control">
          <option value="up">up</option>
          <option value="down">down</option>
        </select>
        <div class="help">说明：向上/向下滚动；可配合 go-top-first 先回到顶部。</div>
      </div>
      <div class="form-row">
        <label>scroll-delay（秒）</label><br />
        <input id="f_scroll_delay" class="form-control" placeholder="例如 1.0" />
        <div class="help">说明：每次滚动后的等待时间；过低会影响 OCR 稳定性；推荐 0.8～1.2。</div>
      </div>
      <div class="form-row">
        <label>max-scrolls</label><br />
        <input id="f_max_scrolls" class="form-control" placeholder="例如 60" />
        <div class="help">说明：限制本次任务的最大滚动次数；较大值适合全量扫描。</div>
      </div>
      <div class="form-row">
        <label>max-scrolls-per-minute（spm）</label><br />
        <input id="f_max_spm" class="form-control" placeholder="例如 40" />
        <div class="help">说明：每分钟最大滚动次数；用于限速，防止封禁风险与页面抖动。</div>
      </div>
      <div class="form-row">
        <label>OCR 语言</label><br />
        <input id="f_ocr_lang" class="form-control" placeholder="例如 ch" />
        <div class="help">说明：默认中文（ch）；英文填写 en；多语言根据 OCR 模型支持配置。</div>
      </div>
      <div class="form-row">
        <label>输出目录</label><br />
        <!-- 输入框: 输出目录。使用相对路径或通用绝对路径示例，避免暴露个人目录 -->
        <input id="f_output_dir" class="form-control" placeholder="例如 ./output 或 /tmp/output" />
        <div class="help">说明：建议使用绝对路径；桌面 UI 在启动前会创建/校验可写性。</div>
      </div>
      <div class="form-row">
        <label>文件前缀</label><br />
        <input id="f_filename_prefix" class="form-control" placeholder="例如 auto_wechat_scan" />
        <div class="help">说明：用于区分不同任务或时间段。</div>
      </div>
      <div class="form-row">
        <label>导出格式</label><br />
        <label title="导出为 JSON"><input type="checkbox" id="fmt_json" /> json</label>
        <label title="导出为 CSV" style="margin-left:8px;"><input type="checkbox" id="fmt_csv" /> csv</label>
        <label title="导出为 Markdown" style="margin-left:8px;"><input type="checkbox" id="fmt_md" /> md</label>
        <div class="help">说明：可多选；保存时以第一个勾选项作为默认主格式写入 config.json。</div>
      </div>
      <div class="form-row">
        <label>选项</label><br />
        <label title="首次回到历史顶部，然后进行全量覆盖扫描"><input type="checkbox" id="f_full_fetch" /> full-fetch</label>
        <label title="任务开始时先滚动至顶部，以提升扫描稳定性" style="margin-left:8px;"><input type="checkbox" id="f_go_top_first" /> go-top-first</label>
        <label title="跳过空消息或系统提示类消息" style="margin-left:8px;"><input type="checkbox" id="f_skip_empty" checked /> skip-empty</label>
        <label title="输出更详细的日志，便于调试定位问题" style="margin-left:8px;"><input type="checkbox" id="f_verbose" checked /> verbose</label>
        <div class="help">说明：
          <span class="section-note">full-fetch 适合首次全量构建，耗时较长；go-top-first 适合从顶部开始，避免遗漏最早消息；skip-empty 跳过空白/系统类消息；verbose 会打印更多调试信息。</span>
        </div>
      </div>
    </div>
    <div style="margin-top:12px;">
      <button class="btn" onclick="loadConfigFromServer()">加载配置</button>
      <button class="btn btn-primary" onclick="saveConfigToServer()">保存到项目</button>
    </div>
  </div>

  <div class="card">
    <h2>网页预览：消息样式示例（ShareCard 与引用气泡）</h2>
    <div>
      <div class="share-card">
        <div class="share-title">秋日咖啡指南</div>
        <div class="share-body">在微风里喝一杯热拿铁</div>
        <div class="share-source">来源：小红书</div>
      </div>
      <div class="share-card">
        <div class="share-title">视觉之旅：穿越光影</div>
        <div class="share-body">UP主：阿B · 播放量：12.3万</div>
        <div class="share-source">来源：哔哩哔哩</div>
      </div>
    </div>
    <div style="margin-top:8px;">
      <div class="bubble other">
        <div class="bubble-label">对方</div>
        <div class="bubble-content">“明天见”</div>
      </div>
      <div class="bubble me">
        <div class="bubble-label">我</div>
        <div class="bubble-content">“请查看这段”</div>
      </div>
    </div>
    <div class="help">说明：上述样式类集中管理于 <code>.share-card</code> 与 <code>.bubble</code>，标题-正文间距≥8px，正文-来源间距≥6px；引用气泡左上角标注“我/对方”。</div>
  </div>

  <div class="card">
    <h2>网页预览：最新导出（来自配置服务）</h2>
    <p>点击按钮从配置服务查询 <code>output/</code> 与 <code>outputs/</code> 目录中最新的导出文件（按修改时间倒序）。</p>
    <div>
      <button class="btn" onclick="fetchLatestExports(10)">查看最新导出（10条）</button>
      <button class="btn" onclick="fetchLatestExports(20)">查看最新导出（20条）</button>
    </div>
    <div style="margin:8px 0;">
      <label>筛选</label>
      <input type="text" id="latest_filter" placeholder="输入关键字过滤（按文件名）" style="width:240px;" oninput="setLatestFilter(this.value)" />
      <span style="margin-left:12px;">排序</span>
      <button class="btn" onclick="setLatestSort('mtime','desc')">按时间（新→旧）</button>
      <button class="btn" onclick="setLatestSort('mtime','asc')">按时间（旧→新）</button>
      <button class="btn" onclick="setLatestSort('name','asc')">按名称（A→Z）</button>
      <button class="btn" onclick="setLatestSort('name','desc')">按名称（Z→A）</button>
      <label style="margin-left:12px;" title="启用后在列表中显示完整真实路径（仅用于显示）">
        <input type="checkbox" id="latest_show_realpaths" onchange="toggleLatestShowRealPaths()" /> 显示真实路径
      </label>
    </div>
      <div class="help">说明：每条目可“复制路径/文件名”“访达中显示”“打开文件”；“显示真实路径”仅影响列表展示，不改变复制/打开行为。桌面版窗口支持相同操作（含右键菜单与快捷键）。</div>
    <div id="latest_exports_area" class="exports-list"></div>
  </div>

  <div class="card">
    <h2>网页预览：性能指标（来自配置服务）</h2>
    <p>点击按钮从配置服务读取当前 OCR 处理器的性能指标快照（平均耗时、缓存命中率与计数）。如未运行过任务，将显示零值或空指标。</p>
    <div>
    <button id="btn_metrics_refresh" class="btn" onclick="fetchMetrics()">刷新指标</button>
    <button id="btn_metrics_reset" class="btn" onclick="resetMetrics()">重置计数（写入快照）</button>
    <button id="btn_metrics_save_snapshot" class="btn" onclick="saveMetricsSnapshot()">保存当前快照（写入文件）</button>
    <button id="btn_metrics_download" class="btn" onclick="downloadCurrentSnapshot()">下载当前快照</button>
      <label style="margin-left:12px;">
        <input type="checkbox" id="metrics_autorefresh" onchange="toggleMetricsAutoRefresh()" /> 自动刷新
      </label>
      <select id="metrics_refresh_interval" onchange="toggleMetricsAutoRefresh()" style="margin-left:6px;">
        <option value="1000">每 1 秒</option>
        <option value="5000">每 5 秒</option>
        <option value="10000" selected>每 10 秒</option>
        <option value="30000">每 30 秒</option>
      </select>
      <span id="metrics_last_fetch" class="help" style="margin-left:8px;">上次拉取：—</span>
    </div>
    <div style="margin-top:6px;">
      <span class="help">命中率阈值：</span>
      良好 ≥ <input type="number" id="metrics_thr_good" min="0" max="1" step="0.01" value="0.90" style="width:80px;" />
      ，告警 < <input type="number" id="metrics_thr_bad" min="0" max="1" step="0.01" value="0.60" style="width:80px;" />
      <button class="btn" onclick="saveMetricsThresholds()" style="margin-left:6px;">保存阈值</button>
      <button class="btn" onclick="resetMetricsThresholds()" style="margin-left:4px;">恢复默认</button>
    </div>
    <div id="metrics_meta" class="help" style="margin-top:4px;">来源：—，schema：—，快照时间：—</div>
    <div id="metrics_area" style="margin-top:8px; font-size:13px;"></div>
  <div class="card">
    <h2>网页预览：权限与提示</h2>
    <div class="banner">隐私说明：页面示例为脱敏展示（<code>$HOME</code> 或通用命令）；复制命令与“打开/访达显示”使用真实路径。你可在下方输入框设置解释器路径。</div>
    <ul>
      <li>在“系统设置 → 隐私与安全性”中授权屏幕录制与辅助功能。</li>
      <li>首次加载 OCR 模型耗时较长属正常。</li>
      <li>桌面 UI 在扫描前会创建/校验输出目录可写性；预览/框选需屏幕录制权限。</li>
      <li>框选窗口可按 <code>Esc</code> 取消。</li>
      <li>auto_wechat_scan.py 不支持 txt，请取消勾选。</li>
    </ul>
  </div>
  <div class="card">
    <h2>网页预览：常见问题（FAQ）</h2>
    <ul>
      <li>
        <strong>UI 启动后立刻退出或提示缺少 Pillow</strong>：先安装 Pillow（见上方“新手指南”第 2 步）。
      </li>
      <li>
        <strong>退出码 -9/134/139 或出现 Segmentation fault</strong>：使用安全模式重试（“新手指南”第 6 步）；安全模式会禁用用户 site 包、启用 paddlex 离线补丁并关闭 GPU。
      </li>
      <li>
        <strong>无法前台控制“微信”窗口</strong>：直接填写聊天区域坐标（<code>x,y,w,h</code>），并在本页点击“预览聊天区域”复制命令进行验证。
      </li>
      <li>
        <strong>OCR 识别效果不稳定</strong>：增大 <code>scroll-delay</code>（如 1.0～1.2 秒）；避免高速滚动导致图像模糊；确认聊天区域覆盖消息列表。
      </li>
    </ul>
  </div>

  <div class="card">
    <h2>网页预览：文件位置</h2>
    <p>UI 源码：<code>ui/simple_gui.py</code></p>
    <p>预览脚本（供 CLI 使用）：<code>scripts/capture_rect_preview.py</code></p>
    <div class="banner"><strong>说明：</strong>桌面 UI 的“预览聊天区域”使用内置截屏（Pillow ImageGrab）；脚本仍适用于命令行场景。</div>
  </div>
    </div>
  </div>

  <footer>
    <small>本页为说明文档，用于在线预览与验证 UI 变更。桌面应用请按上文命令本地运行；你也可以点击“复制运行命令/安装命令”按钮快速复制到剪贴板。</small>
  </footer>
  <script>
    /**
     * 收集交互表单数据为 ui_config.json 结构
     * @returns {Object} UI 配置字典
     */
    function collectUiConfig() {
      return {
        python_bin: document.getElementById('f_python_bin').value.trim(),
        window_title: document.getElementById('f_window_title').value.trim(),
        chat_area: document.getElementById('f_chat_area').value.trim(),
        direction: document.getElementById('f_direction').value,
        scroll_delay: document.getElementById('f_scroll_delay').value.trim(),
        max_scrolls: document.getElementById('f_max_scrolls').value.trim(),
        max_spm: document.getElementById('f_max_spm').value.trim(),
        ocr_lang: document.getElementById('f_ocr_lang').value.trim(),
        output_dir: document.getElementById('f_output_dir').value.trim(),
        filename_prefix: document.getElementById('f_filename_prefix').value.trim(),
        full_fetch: document.getElementById('f_full_fetch').checked,
        go_top_first: document.getElementById('f_go_top_first').checked,
        skip_empty: document.getElementById('f_skip_empty').checked,
        verbose: document.getElementById('f_verbose').checked,
        formats: {
          json: document.getElementById('fmt_json').checked,
          csv: document.getElementById('fmt_csv').checked,
          md: document.getElementById('fmt_md').checked,
        },
      };
    }

    /**
     * 将服务返回的 ui_config.json 数据回填到表单
     * @param {Object} data 服务返回的数据对象
     * @returns {void}
     */
    function fillUiForm(data) {
      document.getElementById('f_python_bin').value = data.python_bin || document.getElementById('f_python_bin').value;
      document.getElementById('f_window_title').value = data.window_title || '';
      document.getElementById('f_chat_area').value = data.chat_area || '';
      document.getElementById('f_direction').value = data.direction || 'up';
      document.getElementById('f_scroll_delay').value = data.scroll_delay || '';
      document.getElementById('f_max_scrolls').value = data.max_scrolls || '';
      document.getElementById('f_max_spm').value = data.max_spm || '';
      document.getElementById('f_ocr_lang').value = data.ocr_lang || 'ch';
      document.getElementById('f_output_dir').value = data.output_dir || '';
      document.getElementById('f_filename_prefix').value = data.filename_prefix || 'auto_wechat_scan';
      const fmts = data.formats || {}; 
      document.getElementById('fmt_json').checked = !!fmts.json;
      document.getElementById('fmt_csv').checked = !!fmts.csv;
      document.getElementById('fmt_md').checked = !!fmts.md;
      document.getElementById('f_full_fetch').checked = !!data.full_fetch;
      document.getElementById('f_go_top_first').checked = !!data.go_top_first;
      document.getElementById('f_skip_empty').checked = data.skip_empty !== undefined ? !!data.skip_empty : true;
      document.getElementById('f_verbose').checked = data.verbose !== undefined ? !!data.verbose : true;
    }

    /**
     * 设置字段错误样式与提示
     * @param {string} inputId 输入框ID
     * @param {string} msg 错误消息
     */
    function setFieldError(inputId, msg) {
      const el = document.getElementById(inputId);
      if (!el) return;
      el.classList.add('error');
      // 若不存在错误提示节点，创建一个
      let err = el.nextElementSibling;
      // 跳过说明 .help
      if (err && err.classList && err.classList.contains('help')) {
        // 在说明后插入错误节点
        const newErr = document.createElement('div');
        newErr.className = 'error-msg';
        newErr.textContent = msg;
        el.parentElement.appendChild(newErr);
        newErr.style.display = 'block';
        return;
      }
      if (!err || !(err.classList && err.classList.contains('error-msg'))) {
        err = document.createElement('div');
        err.className = 'error-msg';
        el.parentNode.insertBefore(err, el.nextSibling);
      }
      err.textContent = msg;
      err.style.display = 'block';
    }

    /**
     * 清除字段错误样式与提示
     * @param {string} inputId 输入框ID
     */
    function clearFieldError(inputId) {
      const el = document.getElementById(inputId);
      if (!el) return;
      el.classList.remove('error');
      const errCandidate = el.nextElementSibling;
      if (errCandidate && errCandidate.classList && errCandidate.classList.contains('error-msg')) {
        errCandidate.style.display = 'none';
      }
      // 同时隐藏后续可能插入的错误节点
      const siblings = el.parentElement.querySelectorAll('.error-msg');
      siblings.forEach(function(n){ n.style.display='none'; });
    }

    /**
     * 表单校验：必要项与格式合法性
     * @returns {{ok:boolean, errors:string[]}}
     */
    function validateUiForm() {
      const errors = [];
      // 需校验的字段：python_bin、chat_area、scroll_delay、max_scrolls、max_spm、output_dir
      const py = document.getElementById('f_python_bin').value.trim();
      clearFieldError('f_python_bin');
      if (!py) { setFieldError('f_python_bin', 'Python 解释器路径不能为空'); errors.push('python_bin'); }

      const chat = document.getElementById('f_chat_area').value.trim();
      clearFieldError('f_chat_area');
      if (chat) {
        const parts = chat.split(',').map(function(s){return s.trim();});
        if (parts.length !== 4) {
          setFieldError('f_chat_area', '坐标格式必须为 x,y,w,h（四个整数，逗号分隔）'); errors.push('chat_area');
        } else {
          const nums = parts.map(function(p){return parseInt(p, 10);});
          const valid = nums.every(function(n){return Number.isFinite(n) && n >= 0;}) && nums[2] > 3 && nums[3] > 3;
          if (!valid) {
            setFieldError('f_chat_area', '坐标必须为非负整数，且 w/h > 3'); errors.push('chat_area');
          }
        }
      }

      const sd = document.getElementById('f_scroll_delay').value.trim();
      clearFieldError('f_scroll_delay');
      if (sd) {
        const v = parseFloat(sd);
        if (!Number.isFinite(v) || v <= 0 || v > 10) {
          setFieldError('f_scroll_delay', 'scroll-delay 必须为 (0, 10] 的数字'); errors.push('scroll_delay');
        }
      }

      const ms = document.getElementById('f_max_scrolls').value.trim();
      clearFieldError('f_max_scrolls');
      if (ms) {
        const v = parseInt(ms, 10);
        if (!Number.isFinite(v) || v < 0 || v > 10000) {
          setFieldError('f_max_scrolls', 'max-scrolls 必须为 0~10000 的整数'); errors.push('max_scrolls');
        }
      }

      const spm = document.getElementById('f_max_spm').value.trim();
      clearFieldError('f_max_spm');
      if (spm) {
        const v = parseInt(spm, 10);
        if (!Number.isFinite(v) || v <= 0 || v > 200) {
          setFieldError('f_max_spm', 'spm 必须为 1~200 的整数'); errors.push('max_spm');
        }
      }

      const outdir = document.getElementById('f_output_dir').value.trim();
      clearFieldError('f_output_dir');
      if (!outdir) { setFieldError('f_output_dir', '输出目录不能为空'); errors.push('output_dir'); }

      return { ok: errors.length === 0, errors: errors };
    }

    /**
     * 针对单字段进行实时校验并更新错误提示
     * @param {string} fieldId 输入框 ID（例如 f_python_bin）
     * @returns {boolean} 是否通过校验
     */
    function validateField(fieldId) {
      let ok = true;
      switch (fieldId) {
        case 'f_python_bin': {
          const v = document.getElementById('f_python_bin').value.trim();
          clearFieldError('f_python_bin');
          if (!v) { setFieldError('f_python_bin', 'Python 解释器路径不能为空'); ok = false; }
          break;
        }
        case 'f_chat_area': {
          const chat = document.getElementById('f_chat_area').value.trim();
          clearFieldError('f_chat_area');
          if (chat) {
            const parts = chat.split(',').map(function(s){return s.trim();});
            if (parts.length !== 4) {
              setFieldError('f_chat_area', '坐标格式必须为 x,y,w,h（四个整数，逗号分隔）'); ok = false;
            } else {
              const nums = parts.map(function(p){return parseInt(p, 10);});
              const valid = nums.every(function(n){return Number.isFinite(n) && n >= 0;}) && nums[2] > 3 && nums[3] > 3;
              if (!valid) { setFieldError('f_chat_area', '坐标必须为非负整数，且 w/h > 3'); ok = false; }
            }
          }
          break;
        }
        case 'f_scroll_delay': {
          const sd = document.getElementById('f_scroll_delay').value.trim();
          clearFieldError('f_scroll_delay');
          if (sd) {
            const v = parseFloat(sd);
            if (!Number.isFinite(v) || v <= 0 || v > 10) { setFieldError('f_scroll_delay', 'scroll-delay 必须为 (0, 10] 的数字'); ok = false; }
          }
          break;
        }
        case 'f_max_scrolls': {
          const ms = document.getElementById('f_max_scrolls').value.trim();
          clearFieldError('f_max_scrolls');
          if (ms) {
            const v = parseInt(ms, 10);
            if (!Number.isFinite(v) || v < 0 || v > 10000) { setFieldError('f_max_scrolls', 'max-scrolls 必须为 0~10000 的整数'); ok = false; }
          }
          break;
        }
        case 'f_max_spm': {
          const spm = document.getElementById('f_max_spm').value.trim();
          clearFieldError('f_max_spm');
          if (spm) {
            const v = parseInt(spm, 10);
            if (!Number.isFinite(v) || v <= 0 || v > 200) { setFieldError('f_max_spm', 'spm 必须为 1~200 的整数'); ok = false; }
          }
          break;
        }
        case 'f_output_dir': {
          const outdir = document.getElementById('f_output_dir').value.trim();
          clearFieldError('f_output_dir');
          if (!outdir) { setFieldError('f_output_dir', '输出目录不能为空'); ok = false; }
          break;
        }
        default:
          break;
      }
      return ok;
    }

    /**
     * 绑定实时校验事件：input/blur 时针对单字段校验
     * @returns {void}
     */
    function bindRealtimeValidation() {
      var ids = ['f_python_bin','f_chat_area','f_scroll_delay','f_max_scrolls','f_max_spm','f_output_dir'];
      ids.forEach(function(id) {
        var el = document.getElementById(id);
        if (!el) return;
        // 输入过程中实时校验但不打断
        el.addEventListener('input', function() { validateField(id); });
        // 失焦时再次校验，确保错误提示准确显示
        el.addEventListener('blur', function() { validateField(id); });
      });
    }

    /**
     * 从本地配置服务加载配置（GET /api/load-config）
     * @returns {Promise<void>}
     */
    async function loadConfigFromServer() {
      try {
        const resp = await fetch('/api/load-config', { method: 'GET' });
        const data = await resp.json();
        if (data && data.ok && data.data) {
          fillUiForm(data.data);
          alert('已加载配置并回填');
        } else {
          alert('加载配置失败：' + (data && data.message ? data.message : '服务不可用或未运行'));
        }
      } catch (err) {
        alert('加载配置失败：' + err);
      }
    }

    /**
     * 保存表单为项目配置（POST /api/save-config）
     * @returns {Promise<void>}
     */
    async function saveConfigToServer() {
      const payload = collectUiConfig();
      const chk = validateUiForm();
      if (!chk.ok) {
        alert('请修正表单错误后再保存（红框字段）');
        return;
      }
      try {
        const resp = await fetch('/api/save-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await resp.json();
        if (data && data.ok) {
          alert('配置已保存到项目：\n- ' + (data.paths && data.paths.ui ? data.paths.ui : 'ui_config.json') + '\n- ' + (data.paths && data.paths.cli ? data.paths.cli : 'config.json'));
        } else {
          alert('保存失败：' + (data && data.message ? data.message : '服务不可用或未运行'));
        }
      } catch (err) {
        alert('保存失败：' + err);
      }
    }

    /**
     * 拉取最新导出文件列表并渲染到页面
     * @param {number} limit 条数上限
     * @returns {Promise<void>}
     */
    async function fetchLatestExports(limit) {
      const area = document.getElementById('latest_exports_area');
      area.innerHTML = '<em>查询中…</em>';
      try {
        const resp = await fetch('/api/latest-exports?limit=' + (limit || 20), { method: 'GET' });
        const data = await resp.json();
        if (!data || !data.ok) {
          area.innerHTML = '<span style="color:#cf1322">查询失败：' + (data && data.message ? data.message : '服务不可用或未运行') + '</span>';
          return;
        }
        // 记录原始数据到全局状态，便于排序与筛选
        window.LATEST_EXPORTS_STATE = window.LATEST_EXPORTS_STATE || { raw: null, sort: { key: 'mtime', order: 'desc' }, filter: '', showReal: false };
        window.LATEST_EXPORTS_STATE.raw = data;
        renderLatestExports(data);
      } catch (e) {
        area.innerHTML = '<span style="color:#cf1322">查询失败：' + e + '</span>';
      }
    }

    /**
     * 设置“最新导出”列表的排序规则并重新渲染
     * @param {('name'|'mtime')} key 排序字段
     * @param {('asc'|'desc')} order 排序方向
     */
    function setLatestSort(key, order) {
      window.LATEST_EXPORTS_STATE = window.LATEST_EXPORTS_STATE || { raw: null, sort: { key: 'mtime', order: 'desc' }, filter: '', showReal: false };
      window.LATEST_EXPORTS_STATE.sort = { key: key, order: order };
      const raw = window.LATEST_EXPORTS_STATE.raw;
      if (raw) { renderLatestExports(raw); }
    }

    /**
     * 设置“最新导出”列表的筛选关键字（按文件名包含）
     * @param {string} text 关键字
     */
    function setLatestFilter(text) {
      window.LATEST_EXPORTS_STATE = window.LATEST_EXPORTS_STATE || { raw: null, sort: { key: 'mtime', order: 'desc' }, filter: '', showReal: false };
      window.LATEST_EXPORTS_STATE.filter = String(text || '').trim();
      const raw = window.LATEST_EXPORTS_STATE.raw;
      if (raw) { renderLatestExports(raw); }
    }

    /**
     * 根据当前状态对 /api/latest-exports 返回的数据进行排序与筛选
     * @param {Object} data 原始数据对象（含 data.output 与 data.outputs）
     * @returns {{output: Array, outputs: Array}} 变换后的两个列表
     */
    function transformLatestExports(data) {
      const state = window.LATEST_EXPORTS_STATE || { sort: { key: 'mtime', order: 'desc' }, filter: '', showReal: false };
      const sortKey = (state.sort && state.sort.key) || 'mtime';
      const sortOrder = (state.sort && state.sort.order) || 'desc';
      const keyword = (state.filter || '').toLowerCase();

      /**
       * 内部助手：复制并应用筛选与排序
       * @param {Array} arr 原始条目数组
       * @returns {Array} 处理后的数组
       */
      function apply(arr) {
        const copy = Array.isArray(arr) ? arr.slice() : [];
        const filtered = keyword
          ? copy.filter(function(x){ return String(x.name || '').toLowerCase().includes(keyword); })
          : copy;
        filtered.sort(function(a, b){
          var va = a[sortKey]; var vb = b[sortKey];
          if (sortKey === 'name') {
            va = String(va || ''); vb = String(vb || '');
            const cmp = va.localeCompare(vb);
            return sortOrder === 'asc' ? cmp : -cmp;
          } else {
            // mtime 可能为 null 或 undefined
            va = (typeof va === 'number') ? va : -Infinity;
            vb = (typeof vb === 'number') ? vb : -Infinity;
            return sortOrder === 'asc' ? (va - vb) : (vb - va);
          }
        });
        return filtered;
      }

      const d = data.data || {};
      return { output: apply(d.output || []), outputs: apply(d.outputs || []) };
    }

    /**
     * 渲染最新导出结果
     * @param {Object} data /api/latest-exports 返回数据
     */
function renderLatestExports(data) {
      const area = document.getElementById('latest_exports_area');
      const d = transformLatestExports(data);
      const root = data.root || '';
      const limit = data.limit || 20;
      const showReal = !!(window.LATEST_EXPORTS_STATE && window.LATEST_EXPORTS_STATE.showReal);
      let html = '';
      /**
       * 将字符串进行基础 HTML 转义，避免在插入到标签文本中时产生歧义
       * @param {string} s 原始字符串
       * @returns {string} 转义后的安全字符串
       */
      function escapeHTML(s) {
        return String(s || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
      function renderSection(title, list) {
        html += '<h3 style="margin:6px 0">' + title + '</h3>';
        if (!list || list.length === 0) {
          html += '<div class="help">(无文件或目录不存在)</div>';
          return;
        }
        html += '<ul>';
        list.forEach(function(item){
          const p = item.path || '';
          const name = item.name || '';
          const m = item.mtime_str || '';
          const safePath = p.replace(/'/g, "\\'");
          const safeName = name.replace(/'/g, "\\'");
          html += '<li>' + name + ' <span class="help">' + m + '</span>' +
                  (showReal ? ' <code class="help" style="user-select:text;">' + escapeHTML(p) + '</code>' : '') +
                  ' <button class="btn" title="复制真实路径（页面不显示完整路径）" onclick="copyText(\'' + safePath + '\')">复制路径</button>' +
                  ' <button class="btn" title="复制文件名" onclick="copyText(\'' + safeName + '\')">复制文件名</button>' +
                  ' <button class="btn" title="在访达中显示真实路径对应的文件" onclick="openInFinder(\'' + safePath + '\')">访达中显示</button>' +
                  ' <button class="btn" title="打开真实路径对应的文件" onclick="openFile(\'' + safePath + '\')">打开文件</button>' +
                  '</li>';
        });
        html += '</ul>';
      }
  var rootDisplay = sanitizePathForDisplay(root);
  html += '<div class="help">根目录：' + rootDisplay + '，展示上限：' + limit + '</div>';
      renderSection('output/', d.output);
      renderSection('outputs/', d.outputs);
      area.innerHTML = html;
    }

    /**
     * 切换“最新导出”列表是否显示真实路径，并持久化用户偏好
     * @returns {void}
     */
    function toggleLatestShowRealPaths() {
      try {
        var cb = document.getElementById('latest_show_realpaths');
        var enabled = !!(cb && cb.checked);
        window.LATEST_EXPORTS_STATE = window.LATEST_EXPORTS_STATE || { raw: null, sort: { key: 'mtime', order: 'desc' }, filter: '', showReal: false };
        window.LATEST_EXPORTS_STATE.showReal = enabled;
        if (typeof localStorage !== 'undefined') {
          localStorage.setItem('latest_exports_showreal', enabled ? '1' : '0');
        }
        var raw = window.LATEST_EXPORTS_STATE.raw;
        if (raw) { renderLatestExports(raw); }
      } catch(e){}
    }

    /**
     * 拉取并渲染 OCR 性能指标（GET /api/metrics）
     * @returns {Promise<void>}
     */
    async function fetchMetrics() {
      const area = document.getElementById('metrics_area');
      area.innerHTML = '<em>加载中…</em>';
      try {
        const resp = await fetch('/api/metrics', { method: 'GET' });
        const data = await resp.json();
        if (!data || !data.ok) {
          area.innerHTML = '<span style="color:#cf1322">读取失败：' + (data && data.message ? data.message : '服务不可用或未运行') + '</span>';
          return;
        }
        // 更新“上次拉取时间”
        updateMetricsLastFetch();
        renderMetrics(
          data.data || {},
          {
            source: data.source,
            schema_version: data.schema_version,
            timestamp: data.timestamp
          }
        );
      } catch (e) {
        area.innerHTML = '<span style="color:#cf1322">读取失败：' + e + '</span>';
      }
    }

    /**
     * 渲染性能指标到页面
     * @param {Object} m 指标对象（含 latency_ms_avg、cache_stats、counters）
     * @returns {void}
     */
    /**
     * 渲染性能指标到页面，并显示元信息（来源、schema 版本、快照时间）
     * @param {Object} m 指标对象（含 latency_ms_avg、cache_stats、counters）
     * @param {{source?:string,schema_version?:string,timestamp?:string}} meta 元信息对象
     * @returns {void}
     */
    function renderMetrics(m, meta) {
      const area = document.getElementById('metrics_area');
      function safeNum(v) { return (typeof v === 'number' && isFinite(v)) ? v : 0; }
      function fmtMs(v) { return safeNum(v).toFixed(2) + ' ms'; }
      function fmtPct(v) { return (safeNum(v) * 100).toFixed(1) + '%'; }
      /**
       * 将 ISO 时间字符串格式化为“YYYY-MM-DD HH:mm:ss”，若无法解析则原样返回
       * @param {string|undefined|null} s ISO 格式时间字符串
       * @returns {string}
       */
      function formatIsoTs(s) {
        try {
          if (!s) return '—';
          var d = new Date(s);
          if (isNaN(d.getTime())) return String(s);
          return (
            d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') +
            ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0') + ':' + String(d.getSeconds()).padStart(2,'0')
          );
        } catch(e) {
          return String(s || '—');
        }
      }

      // 元信息展示（来源/版本/时间）
      try {
        var metaEl = document.getElementById('metrics_meta');
        if (metaEl) {
          var src = (meta && meta.source === 'file') ? '文件快照 (metrics.json)' :
                    (meta && meta.source === 'generated') ? '实时生成 (OCRProcessor)' : String(meta && meta.source || '—');
          var ver = String(meta && meta.schema_version || '—');
          var ts = formatIsoTs(meta && meta.timestamp);
          metaEl.innerHTML = '来源：' + src + '，schema：' + ver + '，快照时间：' + ts;
        }
      } catch(e){}

      const lat = m.latency_ms_avg || {};
      const caches = m.cache_stats || {};
      const ctrs = m.counters || {};

      let html = '';
      html += '<h3 style="margin:6px 0">平均耗时</h3>';
      var latDetect = (typeof lat.detect_regions === 'number') ? lat.detect_regions : lat.detect_and_process_regions;
      var latOcr = (typeof lat.ocr_engine === 'number') ? lat.ocr_engine : lat.ocr_engine_call;
      html += '<ul>' +
              '<li>process_image：' + fmtMs(lat.process_image) + '</li>' +
              '<li>detect_regions：' + fmtMs(latDetect) + ' <span class="help">(兼容旧键 detect_and_process_regions)</span></li>' +
              '<li>ocr_engine：' + fmtMs(latOcr) + ' <span class="help">(兼容旧键 ocr_engine_call)</span></li>' +
              '</ul>';

      /**
       * 渲染单个缓存统计块（含命中率状态高亮）
       * @param {string} name 展示名称
       * @param {Object} obj 缓存统计对象（包含 size、capacity、hit_rate、hits、misses、evictions）
       * @returns {void}
       */
      function renderCache(name, obj) {
        const size = obj && obj.size;
        const capacity = obj && obj.capacity;
        const hr = obj && obj.hit_rate;
        const hits = obj && obj.hits;
        const misses = obj && obj.misses;
        const evict = obj && obj.evictions;
        var thr = getMetricsThresholds();
        var hrClass = 'metric-warn';
        var hrVal = safeNum(hr);
        if (hrVal >= thr.good) { hrClass = 'metric-good'; } else if (hrVal < thr.bad) { hrClass = 'metric-bad'; }
        html += '<h4 style="margin:4px 0">' + name + '</h4>';
        html += '<ul>' +
                '<li>大小/容量：' + safeNum(size) + ' / ' + safeNum(capacity) + '</li>' +
                '<li>命中率：<span class="metric-tag ' + hrClass + '">' + fmtPct(hr) + '</span></li>' +
                '<li>命中/未命中/驱逐：' + safeNum(hits) + ' / ' + safeNum(misses) + ' / ' + safeNum(evict) + '</li>' +
                '</ul>';
      }

      html += '<h3 style="margin:6px 0">缓存统计</h3>';
      renderCache('整图缓存（full_image_cache）', caches.full_image_cache || {});
      renderCache('区域结果缓存（region_cache）', (caches.region_cache || caches.region_results_cache || {}));
      renderCache('OCR 结果缓存（ocr_cache）', caches.ocr_cache || {});

      html += '<h3 style="margin:6px 0">计数</h3>';
      const keys = [
        'process_image_calls','detect_regions_calls','ocr_engine_calls',
        'full_image_cache_hits','full_image_cache_misses','full_image_cache_evictions',
        'region_cache_hits','region_cache_misses','region_cache_evictions',
        'ocr_cache_hits','ocr_cache_misses','ocr_cache_evictions'
      ];
      html += '<ul>' + keys.map(function(k){ return '<li>' + k + '：' + safeNum(ctrs[k]) + '</li>'; }).join('') + '</ul>';

      area.innerHTML = html;
    }

    /**
     * 更新“上次拉取时间”显示
     * @returns {void}
     */
    function updateMetricsLastFetch() {
      var el = document.getElementById('metrics_last_fetch');
      if (!el) return;
      var now = new Date();
      var ts = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') +
               ' ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0') + ':' + String(now.getSeconds()).padStart(2,'0');
      el.textContent = '上次拉取：' + ts;
    }

    /**
     * 启用/停用性能指标自动刷新。开启时按选择的间隔调用 fetchMetrics。
     * @returns {void}
     */
    var _metricsTimer = null;
    function toggleMetricsAutoRefresh() {
      var cb = document.getElementById('metrics_autorefresh');
      var sel = document.getElementById('metrics_refresh_interval');
      if (!cb || !sel) return;
      // 先清除旧的定时器
      if (_metricsTimer) { try { clearInterval(_metricsTimer); } catch(e){} _metricsTimer = null; }
      if (cb.checked) {
        var ms = parseInt(sel.value, 10);
        if (!isFinite(ms) || ms <= 0) ms = 10000;
        // 立即拉取一次，然后启动循环
        try { fetchMetrics(); } catch(e){}
        _metricsTimer = setInterval(function(){ try { fetchMetrics(); } catch(e){} }, ms);
      }
      // 写入偏好
      try {
        localStorage.setItem('metrics_autorefresh_enabled', cb.checked ? '1' : '0');
        localStorage.setItem('metrics_autorefresh_interval', String(sel.value));
      } catch(e){}
    }

    /**
     * 重置指标计数（POST /api/metrics/reset），完成后自动刷新
     * @returns {Promise<void>}
     */
    async function resetMetrics() {
      try {
        const resp = await fetch('/api/metrics/reset', { method: 'POST' });
        const data = await resp.json();
        if (data && data.ok) {
          alert('已写入零值快照并重置计数');
          fetchMetrics();
        } else {
          alert('重置失败：' + (data && data.message ? data.message : '服务不可用或未运行'));
        }
      } catch (e) {
        alert('重置失败：' + e);
      }
    }

    /**
     * 保存当前指标为快照（POST /api/metrics/snapshot），完成后自动刷新
     * @returns {Promise<void>}
     */
    async function saveMetricsSnapshot() {
      try {
        const resp = await fetch('/api/metrics/snapshot', { method: 'POST' });
        const data = await resp.json();
        if (data && data.ok) {
          alert('已保存当前指标为快照：' + (data.path || 'metrics.json'));
          fetchMetrics();
        } else {
          alert('保存快照失败：' + (data && data.message ? data.message : '服务不可用或未运行'));
        }
      } catch (e) {
        alert('保存快照失败：' + e);
      }
    }

    /**
     * 下载当前快照（调用 GET /api/metrics 并在浏览器生成 JSON 文件下载）
     * @returns {Promise<void>}
     */
    async function downloadCurrentSnapshot() {
      try {
        const resp = await fetch('/api/metrics', { method: 'GET' });
        const data = await resp.json();
        if (!data || !data.ok) { alert('读取失败'); return; }
        var payload = data.data || {};
        var s = JSON.stringify(payload, null, 2);
        var blob = new Blob([s], { type: 'application/json' });
        var a = document.createElement('a');
        var ts = (data.timestamp || new Date().toISOString()).replace(/[:T]/g, '-').replace(/\..+$/, '');
        a.download = 'metrics_snapshot_' + ts + '.json';
        a.href = URL.createObjectURL(blob);
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(a.href); document.body.removeChild(a); }, 0);
      } catch (e) {
        alert('下载失败：' + e);
      }
    }

    /**
     * 获取命中率阈值（从 localStorage 读取，缺省 good=0.90, bad=0.60）
     * @returns {{good:number,bad:number}}
     */
    function getMetricsThresholds() {
      var good = 0.90, bad = 0.60;
      try {
        var sGood = localStorage.getItem('metrics_thr_good');
        var sBad = localStorage.getItem('metrics_thr_bad');
        if (sGood) { var v = parseFloat(sGood); if (isFinite(v)) good = v; }
        if (sBad) { var v2 = parseFloat(sBad); if (isFinite(v2)) bad = v2; }
      } catch(e){}
      if (!(good >= 0 && good <= 1)) good = 0.90;
      if (!(bad >= 0 && bad <= 1)) bad = 0.60;
      return { good: good, bad: bad };
    }

    /**
     * 保存命中率阈值到 localStorage，并立即重渲染当前指标（若存在）
     * @returns {void}
     */
    function saveMetricsThresholds() {
      var g = document.getElementById('metrics_thr_good');
      var b = document.getElementById('metrics_thr_bad');
      var gv = parseFloat(g && g.value);
      var bv = parseFloat(b && b.value);
      if (!isFinite(gv) || gv < 0 || gv > 1) gv = 0.90;
      if (!isFinite(bv) || bv < 0 || bv > 1) bv = 0.60;
      try {
        localStorage.setItem('metrics_thr_good', String(gv));
        localStorage.setItem('metrics_thr_bad', String(bv));
      } catch(e){}
      try { fetchMetrics(); } catch(e){}
    }

    /**
     * 恢复阈值默认值并刷新显示
     * @returns {void}
     */
    function resetMetricsThresholds() {
      try {
        localStorage.removeItem('metrics_thr_good');
        localStorage.removeItem('metrics_thr_bad');
      } catch(e){}
      var g = document.getElementById('metrics_thr_good');
      var b = document.getElementById('metrics_thr_bad');
      if (g) g.value = '0.90';
      if (b) b.value = '0.60';
      try { fetchMetrics(); } catch(e){}
    }

    /**
     * 在 macOS Finder 中显示文件（reveal）
     * @param {string} path 文件绝对路径
     */
    async function openInFinder(path) {
      try {
        const resp = await fetch('/api/open-path', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: path, action: 'reveal' }),
        });
        const data = await resp.json();
        if (!data.ok) {
          alert('操作失败：' + (data.message || '未知错误'));
        }
      } catch (e) {
        alert('操作失败：' + e);
      }
    }

    /**
     * 直接打开文件或目录（macOS）
     * @param {string} path 文件绝对路径
     */
    async function openFile(path) {
      try {
        const resp = await fetch('/api/open-path', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: path, action: 'open' }),
        });
        const data = await resp.json();
        if (!data.ok) {
          alert('操作失败：' + (data.message || '未知错误'));
        }
      } catch (e) {
        alert('操作失败：' + e);
      }
    }

    // 页面加载后：回填 Python 解释器路径（仅在有本地保存时回填），并绑定持久化事件
    document.addEventListener('DOMContentLoaded', function() {
      const py = document.getElementById('f_python_bin');
      if (py) {
        const saved = (typeof localStorage !== 'undefined') ? (localStorage.getItem('python_bin') || '').trim() : '';
        // 若输入框为空：仅在存在本地保存时回填；避免显示默认绝对路径导致泄露个人目录
        if (!py.value || py.value.trim().length === 0) {
          if (saved) {
            py.value = saved;
            // 初次回填后持久化，便于下次自动记忆
            try { persistPythonBin(); } catch(e){}
          }
        }
        // 用户修改时持久化
        py.addEventListener('change', persistPythonBin);
        py.addEventListener('blur', persistPythonBin);
      }
      // 绑定实时校验事件
      bindRealtimeValidation();
      // 初次加载尝试读取一次指标，便于快速验证
      try { fetchMetrics(); } catch(e){}
      // 恢复自动刷新偏好
      try {
        var cb = document.getElementById('metrics_autorefresh');
        var sel = document.getElementById('metrics_refresh_interval');
        var en = localStorage.getItem('metrics_autorefresh_enabled');
        var iv = localStorage.getItem('metrics_autorefresh_interval');
        if (cb) cb.checked = (en === '1');
        if (sel && iv) sel.value = iv;
        toggleMetricsAutoRefresh();
      } catch(e){}
      // 恢复“最新导出”显示真实路径偏好
      try {
        var showRealSaved = (typeof localStorage !== 'undefined') ? localStorage.getItem('latest_exports_showreal') : null;
        var showReal = (showRealSaved === '1');
        var cbReal = document.getElementById('latest_show_realpaths');
        if (cbReal) cbReal.checked = showReal;
        window.LATEST_EXPORTS_STATE = window.LATEST_EXPORTS_STATE || { raw: null, sort: { key: 'mtime', order: 'desc' }, filter: '', showReal: false };
        window.LATEST_EXPORTS_STATE.showReal = showReal;
      } catch(e){}
      // 回填阈值偏好
      try {
        var thr = getMetricsThresholds();
        var g = document.getElementById('metrics_thr_good');
        var b = document.getElementById('metrics_thr_bad');
        if (g) g.value = String(thr.good);
        if (b) b.value = String(thr.bad);
      } catch(e){}
    });
  </script>
</body>
</html>
  <div class="back-to-toc"><a href="#toc">返回目录</a></div>